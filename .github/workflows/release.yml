name: Publish Release

on:
  push:
    tags:
      - "*.*.*"
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Create virtual environment
        run: uv venv

      - name: Determine release version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            version=$(git describe --tags --abbrev=0)
          else
            version="${GITHUB_REF_NAME}"
          fi
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Validate changelog entry
        run: |
          version="${{ steps.version.outputs.version }}"
          if ! grep -q "## ${version}" CHANGELOG.md; then
            echo "::error::CHANGELOG.md is missing an entry for ${version}"
            exit 1
          fi

      - name: Ensure pyproject version matches tag
        run: |
          version="${{ steps.version.outputs.version }}"
          file_version=$(python -c "import tomllib; from pathlib import Path; data = tomllib.loads(Path('pyproject.toml').read_text()); print(data['project']['version'])")
          if [ "$version" != "$file_version" ]; then
            echo "::error::pyproject version ($file_version) does not match tag ($version)"
            exit 1
          fi

      - name: Install build tooling
        run: uv pip install -e ".[build]"

      - name: Build distribution
        run: uv build

      - name: Generate release notes from changelog
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"
          awk -v ver="${version}" 'BEGIN{found=0}
            {
              if ($0 ~ "^## " ver) {found=1; next}
              if (found && /^## /) exit
              if (found) print
            }
            END {if (found == 0) exit 1}' CHANGELOG.md | sed '/^\s*$/d' > release_notes.md
          if [ ! -s release_notes.md ]; then
            echo "::error::No release notes found for ${version} in CHANGELOG.md" >&2
            exit 1
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          body_path: release_notes.md

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
